<!DOCTYPE html>

<html><head><meta charset="utf-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="/apple-touch-icon-57x57.png" rel="apple-touch-icon" sizes="57x57" /><link href="/apple-touch-icon-60x60.png" rel="apple-touch-icon" sizes="60x60" /><link href="/apple-touch-icon-72x72.png" rel="apple-touch-icon" sizes="72x72" /><link href="/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76" /><link href="/apple-touch-icon-114x114.png" rel="apple-touch-icon" sizes="114x114" /><link href="/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120" /><link href="/apple-touch-icon-144x144.png" rel="apple-touch-icon" sizes="144x144" /><link href="/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152" /><link href="/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180" /><link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" /><link href="/android-chrome-192x192.png" rel="icon" sizes="192x192" type="image/png" /><link href="/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png" /><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" /><link href="manifest.json" rel="manifest" /><link color="#5bbad5" href="/safari-pinned-tab.svg" rel="mask-icon" /><meta content="#da532c" name="msapplication-TileColor" /><meta content="/mstile-144x144.png" name="msapplication-TileImage" /><meta content="#ffffff" name="theme-color" /><link href="/bundles/28a3f0024957/all.min.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Lato:400,300,400italic,700,900" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Quicksand:400,700" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Josefin+Sans:400,700italic,700,600italic,600,400italic,300italic,300" rel="stylesheet" type="text/css" /><script src="/bundles/8181a25eaea5/all.min.js"></script><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-22539794-3","auto"),ga("send","pageview");</script><title>Peter M. Elias - Full Stack Developer</title></head><body><section class="l-header"><article class="header-mini"><article class="header-mini__content"><a href="/"></a><h6 class="header-mini__title">P<span class="header-mini__red">M</span>E</h6><h5 class="header-mini__current-page">writing</h5></article></article></section><section class="l-main" id="main"><section class="l-navigation"><article class="navlist" id="navlist"><article class="spin-button" id="navlist-expand"><span class="spin-button__icon"></span></article><ul class="navlist__list" id="navlist-list"><li class="navlist__item  "><a href="/portfolio">portfolio</a></li><li class="navlist__item  active"><a href="/writings">writings</a></li><li class="navlist__item  "><a href="/hire-me">hiring me</a></li><li class="navlist__item  "><a href="/about">about me</a></li><li class="navlist__item  "><a href="https://www.github.com/petermelias" target="_blank">github</a></li></ul></article></section><section class="l-page"><section class="writing"><h5>One Way to Structure and Bootstrap a Tiered Flask Application</h5><p>This is assuming you are working on a fairly large Flask app and you are using Blueprints and lots of models and services.</p><p>I like to break my Flask apps up into Blueprints corresponding to major view features. I keep my models all under a <code>models</code> package that contains sub-packages with model classes, functions, tests signals and so forth.</p><p>I like to put my services into a package with one module for each service.</p><p>It might look something like:</p>
<pre><code class="codehilite"><span class="o">--&gt;</span> <span class="n">app</span>
    <span class="o">--</span> <span class="n">models</span>
      <span class="o">--</span> <span class="n">user</span>
          <span class="o">--</span> <span class="n">objects</span><span class="p">.</span><span class="n">py</span>
          <span class="o">--</span> <span class="n">fxns</span><span class="p">.</span><span class="n">py</span>
          <span class="o">--</span> <span class="n">signals</span><span class="p">.</span><span class="n">py</span>
          <span class="o">--</span> <span class="n">tests</span><span class="p">.</span><span class="n">py</span>
          <span class="o">--</span> <span class="n">fixtures</span><span class="p">.</span><span class="n">py</span>
    <span class="o">--</span> <span class="n">blueprints</span>
        <span class="o">--</span> <span class="n">admin</span>
          <span class="o">--</span> <span class="n">users</span>
              <span class="o">--</span> <span class="n">endpoints</span><span class="p">.</span><span class="n">py</span>
              <span class="o">--</span> <span class="n">tests</span><span class="p">.</span><span class="n">py</span>
          <span class="o">--</span> <span class="n">context</span><span class="p">.</span><span class="n">py</span>
          <span class="o">--</span> <span class="n">decoratorys</span><span class="p">.</span><span class="n">py</span>
          <span class="o">--</span> <span class="n">helpers</span><span class="p">.</span><span class="n">py</span>
        <span class="o">--</span> <span class="n">public</span>
          <span class="o">--</span> <span class="n">flat</span>
              <span class="o">--</span> <span class="n">endpoints</span><span class="p">.</span><span class="n">py</span>
              <span class="o">--</span> <span class="n">tests</span><span class="p">.</span><span class="n">py</span>
    <span class="o">--</span> <span class="n">services</span>
        <span class="o">--</span> <span class="n">emails</span><span class="p">.</span><span class="n">py</span>
        <span class="o">--</span> <span class="n">database</span><span class="p">.</span><span class="n">py</span>
</code></pre><p>I like to do this because it keeps the application tiers and their parts nicely separated and standardized. It also makes bootstrapping different parts really flexible.</p><p>My application factory function might look something like this:</p>
<pre><code class="codehilite"><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">loglevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'loglevel'</span><span class="p">,</span> <span class="s">'warning'</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">loglevel</span><span class="p">))</span>

    <span class="n">webapp</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">Flask</span><span class="p">(</span><span class="s">'app'</span><span class="p">,</span> <span class="n">template_folder</span><span class="o">=</span><span class="s">'ui/modules'</span><span class="p">)</span>
    <span class="n">webapp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">'ENV'</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'APP_ENV'</span><span class="p">,</span> <span class="s">'local'</span><span class="p">))</span>
    <span class="n">webapp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">'MODE'</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'APP_MODE'</span><span class="p">,</span> <span class="s">'development'</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'mode'</span><span class="p">):</span>
        <span class="n">webapp</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MODE'</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'mode'</span><span class="p">)</span>

    <span class="n">webapp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_parse_settings</span><span class="p">(</span><span class="n">webapp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'MODE'</span><span class="p">)))</span>

    <span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">services</span>
    <span class="n">services</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">webapp</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">models</span>
    <span class="n">models</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">webapp</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">view</span>
    <span class="n">view</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">webapp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">webapp</span>
</code></pre><p>This affords me the power to customize the initialization of each major application tier independently.</p><p>You might notice we're actually passing the application object to the individual initialization functions.</p><p>If you're familiar with Flask you'll know that the <code>Flask.current_app</code> thread-local could actually provide us with this reference but <em>only</em> if we are inside an application-context.</p><p>Since we're bootstrapping and have not pushed a context (and may not want to) we pass the reference directly so that the sub-init functions can work directly with the newly instantiated app object.</p><p>A sub-init function for services might look something like this:</p>
<pre><code class="codehilite"><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">postgres</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">proxy_fix</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">_init_session_store</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'ENABLE_REACT_RENDERING'</span><span class="p">):</span>
        <span class="n">react_server</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="n">email_notifications</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</code></pre><p>Oh look at that fun twist: we can now use application configuration values to have granular control over what application services get booted or not. For example, if we're just running model database tests and we need a test application object for that, we don't need it to try and connect to the React rendering server. That's overhead, and requires us to keep a React rendering server running locally when all we want to do is run unit tests.</p><p>In a similar fashion, we can easily swap out what database we're using. Instead of calling <code>postgres.init(app)</code> we could just call <code>maria.init(app)</code> or use both if we wanted.</p><p>Point is, this is now entirely encapsulated to the service layer where it belongs and we no longer concern ourselves with the details of a large bootstrapping process in the main factory function.</p><p>The initialization of each component is its own concern and merely receives the application object when told to initialize.</p><p>This pattern may seem simple (because it is) but saves a lot of growing pains later on if your Flask app plans on becoming anything more than a weekend prototype.</p></section></section></section><section class="l-footer"><footer><section class="footer-content"><p class="footer__text">copyright peter m elias 2003 - 2016</p></section></footer></section><button class="js-intercom-cta hidden"></button><script src="/javascript/intercom.js" type="text/javascript"></script></body></html>