<!DOCTYPE html>

<html><head><meta charset="utf-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="/apple-touch-icon-57x57.png" rel="apple-touch-icon" sizes="57x57" /><link href="/apple-touch-icon-60x60.png" rel="apple-touch-icon" sizes="60x60" /><link href="/apple-touch-icon-72x72.png" rel="apple-touch-icon" sizes="72x72" /><link href="/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76" /><link href="/apple-touch-icon-114x114.png" rel="apple-touch-icon" sizes="114x114" /><link href="/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120" /><link href="/apple-touch-icon-144x144.png" rel="apple-touch-icon" sizes="144x144" /><link href="/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152" /><link href="/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180" /><link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" /><link href="/android-chrome-192x192.png" rel="icon" sizes="192x192" type="image/png" /><link href="/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png" /><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" /><link href="manifest.json" rel="manifest" /><link color="#5bbad5" href="/safari-pinned-tab.svg" rel="mask-icon" /><meta content="#da532c" name="msapplication-TileColor" /><meta content="/mstile-144x144.png" name="msapplication-TileImage" /><meta content="#ffffff" name="theme-color" /><link href="/bundles/f75509d23d13/all.min.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Lato:400,300,400italic,700,900" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Quicksand:400,700" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Josefin+Sans:400,700italic,700,600italic,600,400italic,300italic,300" rel="stylesheet" type="text/css" /><script src="/bundles/a9f223413071/all.min.js"></script><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-22539794-3","auto"),ga("send","pageview");</script><title>Peter M. Elias - Full Stack Developer</title></head><body><section class="l-header"><article class="header-mini"><article class="header-mini__content"><a href="/"></a><h6 class="header-mini__title">P<span class="header-mini__red">M</span>E</h6><h5 class="header-mini__current-page">writing</h5></article></article></section><section class="l-main" id="main"><section class="l-navigation"><article class="navlist" id="navlist"><article class="spin-button" id="navlist-expand"><span class="spin-button__icon"></span></article><ul class="navlist__list" id="navlist-list"><li class="navlist__item  "><a href="/projects/">projects</a></li><li class="navlist__item  active"><a href="https://medium.com/@petermelias" target="_blank">writings</a></li><li class="navlist__item  "><a href="/engineering-philosophy/">engineering</a></li><li class="navlist__item  "><a href="/about/">about</a></li><li class="navlist__item  "><a href="https://www.github.com/petermelias" target="_blank">github</a></li></ul></article></section><section class="l-page"><section class="writing"><h5>Setting up Blue Green Deployments on EC2 with Plain Ole' Bash</h5><p>Now, before we get into this I'd like to just disclaim that if you are looking to set up blue / green deployments for a large scale system under any significant load, you should obviously use a purpose-built tool for this (and other) dev-ops task(s).</p><p>I would recommend good old <a href="https://github.com/Netflix/asgard" target="_blank">Asgard</a> or something of that ilk.</p><p>Finally, this write-up assumes you are comfortable with the following: 1. BASH and the CLI 2. AWS in general 3. </p><p>Situation: you have a decently trafficked site that you want to continuously deploy to EC2 with zero-downtime. You are not looking to make the investment of learning and / or setting up a comprehensive cloud management solution (just quite yet).</p><p>The first thing to do is get AWS CodeDeploy set up and running so that you can easily integrate your remote repositories (like Github) with AWS.</p><p>CodeDeploy can mostly configured to connect to Github (or other remote SCM) via the interface on the AWS console. The main thing you need to do is ensure that the AMI for your EC2 instances includes a running installation of the CodeDeploy agent.</p><p>You also need to ensure that you have configured the CodeDeploy IAM user and and policy correctly to allow the instances to poll the CodeDeploy service and receive updates. You can read more about that part <a href="http://docs.aws.amazon.com/codedeploy/latest/userguide/getting-started-setup.html" target="_blank">here</a>.</p><p>I will write a separate and more detailed article on that process in the future.</p><p>Once you have set up your CodeDeploy IAM user and profile. You need to make sure that the AMI you are using for your application instances is set up with the CodeDeploy role. You can read more about that part <a href="http://docs.aws.amazon.com/codedeploy/latest/userguide/how-to-create-service-role.html" target="_blank">here</a>.</p><p>The reason it is necessary to have a working CodeDeploy setup is because you need to be able to track the build version that is running on each group of instances. This is what enables the blue/green separation as well as other features like rollback and canary deployments.</p><p>Make sure thet the following code runs during set up of the AMI you are using to provision new instances:</p>
<pre><code class="codehilite"><span class="nb">cd</span> /home/ec2-user
aws s3 cp s3://aws-codedeploy-us-east-1/latest/install . --region us-east-1
chmod +x ./install
./install auto
rm ./install
</code></pre><p>A good place to put this is either in the <code>UserData</code> field that EC2 uses to bootstrap new instances or in some kind of <code>setup.sh</code> that gets run when the AMI boots up.</p><p>The reason you might not want to pre-install the CodeDeploy agent on your AMI during packaging is because you want to make sure your instances are always provisioning with the latest version of the agent.</p><p>You can manually verify that the agent is running on your test instance by <code>tail</code>ing the log file for the agent in <code>/var/log</code>.</p><p>Quick progress check:</p>
<ol>
  <li>Set up CodeDeploy IAM user</li>
  <li>Set up CodeDeploy IAM profile</li>
  <li>Set up CodeDeploy service role (and attached to EC2 AMI <em>important</em>)</li>
  <li>Set up the download and install code for the CodeDeploy agent on the AMI.</li>
</ol><p>If you've done all that and can verify it is working, let's move on to the blue green part.</p><p>Essentially the trick to making this "poor man's" B/G setup work is EC2's auto-scaling groups. By creating at least 2 auto-scaling groups and swapping their attachment to your <em>production</em> load balancer, you can do easily create a simple blue green strategy from the command line.</p><p>The first part of this is to setup our CodeDeploy deployment configurations.</p>
<ol>
  <li>Make 2 auto-scaling groups (I call them <code>Alpha</code> and <code>Bravo</code>)</li>
  <li>Create 2 corresponding CodeDeploy Deployment Groups and link them to the appropriate auto-scaling group.</li>
  <li>Set the service role for the Deployment group to the CodeDeploy service role you created earlier.</li>
  <li>Set the deployment configuration to "All at Once" for now.</li>
</ol><p>Now is a good time to just test your deployments and make sure they are working before we talk about the blue green part.</p><p>You can do this with the following steps:</p>
<ol>
  <li>Set the instance count on the <code>Alpha</code> ASG to 1.</li>
  <li>Attach <code>Alpha</code> to the Production ELB (or any ELB you can test from)</li>
  <li>Create a deployment (using the interface for ease of testing) for <code>Alpha</code>'s deployment group.</li>
  <li><code>tail -f</code> the CodeDeploy agent log on the instance in <code>Alpha</code> and monitor the progress of the deployment. The interface will show a successful deployment if the agent succeeds, and the log will show you what went wrong if the agent fails.</li>
</ol>
<blockquote><p>Pro Tip: The primary determinants of the correct functioning of the CodeDeploy agent are the life-cycle scripts you set up with your payload.</p>
</blockquote></section></section></section><section class="l-footer"><footer><section class="footer-content"><p class="footer__text">copyright peter m elias 2003 - 2017</p></section></footer></section><button class="js-intercom-cta hidden"></button><script src="/javascript/intercom.js" type="text/javascript"></script></body></html>